<!DOCTYPE html>
<html lang="zh" data-theme="light" dir="ltr">
  <head>
    <title>关于接口限流的一次简单实践 - 慕予博客</title>
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
    <meta name="description" content="简单是效率的灵魂"/>

    <meta property="og:title" content="慕予博客 -&nbsp;关于接口限流的一次简单实践" />
    <meta property="og:type" content="website"/><meta property="og:url" content="https:&#x2F;&#x2F;ilikexff.cn&#x2F;guan-yu-jie-kou-xian-liu-de-yi-ci-jian-dan-shi-jian&#x2F;"/><meta property="og:description" content="简单是效率的灵魂"/>


    <meta name="twitter:card" content="summary">


    <link rel="stylesheet" href="https://ilikexff.cn/spectre/spectre.css">
    <link rel="stylesheet" href="https://ilikexff.cn/theme.css"><link rel="stylesheet" href="https://ilikexff.cn/custom.css">
    

        
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.css" integrity="sha384-Xi8rHCmBmhbuyyhbI88391ZKP2dmfnOl4rT9ZfRI7mLTdk1wblIUnrIq35nqwEvC" crossorigin="anonymous">

    <!-- The loading of KaTeX is deferred to speed up page rendering -->
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.js" integrity="sha384-X/XCfMm41VSsqRNQgDerQczD69XqmjOOOwYQvr/uuC+j4OPoNhVgjdGFwhvN02Ja" crossorigin="anonymous"></script>

    <!-- To automatically render math in text elements, include the auto-render extension: -->
    <script>
        function doRenderMath() {
            renderMathInElement(document.body, {
                delimiters: [
                {left: "$$", right: "$$", display: true},
                {left: "$", right: "$", display: false},
                {left: "\\(", right: "\\)", display: false},
                {left: "\\begin{equation}", right: "\\end{equation}", display: true},
                {left: "\\begin{align}", right: "\\end{align}", display: true},
                {left: "\\begin{alignat}", right: "\\end{alignat}", display: true},
                {left: "\\begin{gather}", right: "\\end{gather}", display: true},
                {left: "\\begin{CD}", right: "\\end{CD}", display: true},
                {left: "\\[", right: "\\]", display: true}
                ]
            });
        }
    </script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/auto-render.min.js" integrity="sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR" crossorigin="anonymous"
        onload="doRenderMath()"></script>

      </head>
  <body id="top" class="sticky-footer"><div id="page-wrapper">
<header id="header" class="section">
  <section class="container grid-xl">
    <nav class="navbar">
      <section class="navbar-section">
        
<a class="site-logo" href="https:&#x2F;&#x2F;ilikexff.cn">
  
  <div class="col-mx-auto">
    <figure style="margin: 8px">
      <img class="img-responsive"
           style="max-height: 45px"
           alt="frontmatter image"
           src="https://ilikexff.cn/./logo.svg">
    </figure>
  </div>
  
</a>

      </section><!-- ./home button -->

      <section class="navbar-center hide-md"></section>

      <section class="navbar-section">
        <nav class="dropmenu animated hide-md">

<ul><li>
        <a href="https://ilikexff.cn/tags">标签</a>
    </li><li>
        <a href="https://ilikexff.cn/categories">分类</a>
    </li><li>
        <a href="https://ilikexff.cn/about">关于</a>
    </li></ul>


          </nav>
      </section><!-- ./desktop-menu -->
    </nav>
  </section><!-- ./container -->
</header>


<div class="mobile-menu">
  <div class="button_container" id="toggle" onclick="openOverlay()">
    <span class="top"></span>
    <span class="middle"></span>
    <span class="bottom"></span>
  </div>
</div><!--./mobile-menu-->


<section id="start"><section id="body-wrapper" class="section">
          <section class="container grid-xl">
<div id="breadcrumbs" itemtype="http://schema.org/BreadcrumbList" class="hide-sm">
  
    
    <span><a href="https:&#x2F;&#x2F;ilikexff.cn&#x2F;">Home</a></span>
  
    <span><a href="https:&#x2F;&#x2F;ilikexff.cn&#x2F;guan-yu-jie-kou-xian-liu-de-yi-ci-jian-dan-shi-jian&#x2F;">关于接口限流的一次简单实践</a></span>
</div>
<div class="columns">
              <div id="item" class="column col-8 col-md-12 extra-spacing">
<div class="card">
  

    <div class="card-header">
      <div class="card-title" style="margin-top: .25rem;"><div>
          <h1 class="post-title">关于接口限流的一次简单实践</h1>
          
    <div class="post-meta" style="display: inline-flex">
        <span class="blog-date" style="display: inline-flex;">
          <i class="gg-calendar" style="margin-right: 5px;"></i><time datetime="2023.06.15">
          2023.06.15
          </time></span><span class="post-author" style="margin-left: 5px; display: inline-flex;">
          - 
    慕予
        </span></div>

        </div></div>
    </div><!--./card-header-->

    <div class="card-body">
      
        <h2 id="1-xie-zhe-pian-wen-zhang-de-lai-you">1.写这篇文章的来由<a class="zola-anchor" href="#1-xie-zhe-pian-wen-zhang-de-lai-you" aria-label="Anchor link for: 1-xie-zhe-pian-wen-zhang-de-lai-you">🔗</a></h2>
<p>有一段时间里，博客总是三天两头被打，其中就遇到了恶意刷接口的手段，对方明显使用的代码IP，由于博客并没有做这方面的措施，加上被大量盗刷的接口刚好是数据量最大的一篇文章数据，所以不出意外的，博客没多久就崩了。服务器状态也是各种异常。所以吃一堑长一智吧算是，我也没想到<strong>面对</strong>一个个人小破站，<strong>对面</strong>也是饥不择食….真<strong>大黑客</strong>啊兄弟们！！！</p>
<p><img src="https://images.waer.ltd/img/ERROR.jpg" alt="ERROR" /></p>
<hr />
<h2 id="2-jie-kou-xian-liu-de-chang-jian-shou-duan">2.接口限流的常见手段<a class="zola-anchor" href="#2-jie-kou-xian-liu-de-chang-jian-shou-duan" aria-label="Anchor link for: 2-jie-kou-xian-liu-de-chang-jian-shou-duan">🔗</a></h2>
<p>​	现在来说，做限流的各种方案其实已经相对很成熟了，这里也是大致列举了几种常用的解决方案，但不会全部都细说。</p>
<p>毕竟很多都还是自己没有实际使用过的，光搞理论是没什么意义的，所以后续有时间打算一个个揪出来细搞，起码得到用过了再写篇文章总结一下吧。</p>
<blockquote>
<p>Java中常用的限流解决方案:</p>
</blockquote>
<ul>
<li><strong>计数器</strong></li>
<li>滑动窗口</li>
<li>漏桶</li>
<li>令牌桶</li>
<li><code>Redis+Lua</code>分布式限流</li>
</ul>
<p>由于我博客采用的就是计数器方案，所以这里主要记录一下整个大致的限流原理以及实践过程。</p>
<p>上面几种方案中，计数器算是最简单的限流算法了。原理就是在指定的时间间隔内，对接口的请求次数进行限制，具体到我的博客为例，我是针对每个<code>IP</code>进行的请求限制，对请求进行计数，判断请求数量与阈值的情况，决定是否需要限流，每个<code>IP</code>触发限流之后会有一定的时间周期，计数器到时清零即可。</p>
<p>这就是计数器限流基本的原理。具体的实现上，我选用了<code>Redis</code>作为了计数限流的中间件，所以也可以理解为，这是<code>Redis+</code>计数器的一种实现方式。具体执行的逻辑如下:</p>
<blockquote>
<ul>
<li>设置好计数器<code>count</code>，每过一次请求计数器就<code>+1</code>，同时记录对应的请求<code>IP</code>；</li>
<li>当下一个请求到来之际，首先通过<code>IP</code>判断对应的计数器是否达到了限流的频次，以及本次请求是否还在设定的请求周期内；</li>
<li>如果请求已触发限流阈值，则针对该<code>IP</code>开启限流，后面的所有请求均直接拒绝。</li>
<li>当被限流<code>IP</code>达到时间周期满之后，将<code>count</code>重置，计数器进入下一轮的就绪状态。</li>
</ul>
</blockquote>
<p>原理也是蛮简单的，我也是蛮喜欢这种方式的(<strong>床言床语</strong>😀）。下面开始具体的实操部分。</p>
<hr />
<h2 id="3-ji-shu-qi-xian-liu-shi-jian">3.计数器限流实践<a class="zola-anchor" href="#3-ji-shu-qi-xian-liu-shi-jian" aria-label="Anchor link for: 3-ji-shu-qi-xian-liu-shi-jian">🔗</a></h2>
<p>首先确定实现的具体方案，上面说了，我这里用的是<code>Redis</code>作为限流计数器的记录以及限流状态的重置等操作。具体限流的逻辑直接写以<code>Java</code>带代码写在了项目业务中。</p>
<p>特别的，由于是通过<code>IP</code>来限流的，所以这里需要用大的几个处理<code>IP</code>地址的工具类就先贴出来。</p>
<blockquote>
<p>个人习惯，我贴代码会将所有<code>import</code>的包都一起贴进来，这样是方便后续回顾或者学习的时候处理一些包的问题，之前就遇到过很多类似的问题(可能对小白不太友好)，代码是有了，结果在导包的时候要么是对用到的哪些包不明所以，要么是同名的包过多，不知道怎么选择。</p>
</blockquote>
<h3 id="3-1-ipgong-ju-lei">3.1 IP工具类<a class="zola-anchor" href="#3-1-ipgong-ju-lei" aria-label="Anchor link for: 3-1-ipgong-ju-lei">🔗</a></h3>
<pre data-lang="java" style="background-color:#002b36;color:#839496;" class="language-java "><code class="language-java" data-lang="java"><span style="color:#cb4b16;">import </span><span style="color:#859900;">eu</span><span>.</span><span style="color:#859900;">bitwalker</span><span>.</span><span style="color:#859900;">useragentutils</span><span>.</span><span style="color:#859900;">UserAgent</span><span>;
</span><span style="color:#cb4b16;">import </span><span style="color:#859900;">lombok</span><span>.</span><span style="color:#859900;">extern</span><span>.</span><span style="color:#859900;">slf4j</span><span>.</span><span style="color:#859900;">Slf4j</span><span>;
</span><span style="color:#cb4b16;">import </span><span style="color:#859900;">org</span><span>.</span><span style="color:#859900;">apache</span><span>.</span><span style="color:#859900;">commons</span><span>.</span><span style="color:#859900;">lang3</span><span>.</span><span style="color:#859900;">StringUtils</span><span>;
</span><span style="color:#cb4b16;">import </span><span style="color:#859900;">org</span><span>.</span><span style="color:#859900;">lionsoul</span><span>.</span><span style="color:#859900;">ip2region</span><span>.</span><span style="color:#859900;">DataBlock</span><span>;
</span><span style="color:#cb4b16;">import </span><span style="color:#859900;">org</span><span>.</span><span style="color:#859900;">lionsoul</span><span>.</span><span style="color:#859900;">ip2region</span><span>.</span><span style="color:#859900;">DbConfig</span><span>;
</span><span style="color:#cb4b16;">import </span><span style="color:#859900;">org</span><span>.</span><span style="color:#859900;">lionsoul</span><span>.</span><span style="color:#859900;">ip2region</span><span>.</span><span style="color:#859900;">DbSearcher</span><span>;
</span><span style="color:#cb4b16;">import </span><span style="color:#859900;">org</span><span>.</span><span style="color:#859900;">lionsoul</span><span>.</span><span style="color:#859900;">ip2region</span><span>.</span><span style="color:#859900;">Util</span><span>;
</span><span style="color:#cb4b16;">import </span><span style="color:#859900;">org</span><span>.</span><span style="color:#859900;">springframework</span><span>.</span><span style="color:#859900;">core</span><span>.</span><span style="color:#859900;">io</span><span>.</span><span style="color:#859900;">ClassPathResource</span><span>;
</span><span style="color:#cb4b16;">import </span><span style="color:#859900;">org</span><span>.</span><span style="color:#859900;">springframework</span><span>.</span><span style="color:#859900;">stereotype</span><span>.</span><span style="color:#859900;">Component</span><span>;
</span><span style="color:#cb4b16;">import </span><span style="color:#859900;">org</span><span>.</span><span style="color:#859900;">springframework</span><span>.</span><span style="color:#859900;">util</span><span>.</span><span style="color:#859900;">FileCopyUtils</span><span>;
</span><span style="color:#cb4b16;">import </span><span style="color:#859900;">javax</span><span>.</span><span style="color:#859900;">annotation</span><span>.</span><span style="color:#859900;">PostConstruct</span><span>;
</span><span style="color:#cb4b16;">import </span><span style="color:#859900;">javax</span><span>.</span><span style="color:#859900;">servlet</span><span>.</span><span style="color:#859900;">http</span><span>.</span><span style="color:#859900;">HttpServletRequest</span><span>;
</span><span style="color:#cb4b16;">import </span><span style="color:#859900;">java</span><span>.</span><span style="color:#859900;">io</span><span>.</span><span style="color:#859900;">InputStream</span><span>;
</span><span style="color:#cb4b16;">import </span><span style="color:#859900;">java</span><span>.</span><span style="color:#859900;">lang</span><span>.</span><span style="color:#859900;">reflect</span><span>.</span><span style="color:#859900;">Method</span><span>;
</span><span style="color:#cb4b16;">import </span><span style="color:#859900;">java</span><span>.</span><span style="color:#859900;">net</span><span>.</span><span style="color:#859900;">InetAddress</span><span>;
</span><span style="color:#cb4b16;">import </span><span style="color:#859900;">java</span><span>.</span><span style="color:#859900;">net</span><span>.</span><span style="color:#859900;">UnknownHostException</span><span>;
</span><span>
</span><span>
</span><span>@</span><span style="color:#268bd2;">Slf4j
</span><span>@</span><span style="color:#268bd2;">Component
</span><span style="color:#93a1a1;">public </span><span style="color:#268bd2;">class </span><span style="color:#b58900;">IpUtils </span><span style="color:#657b83;">{
</span><span>    
</span><span>    
</span><span>    </span><span style="color:#586e75;">/**
</span><span style="color:#586e75;">     * 获取ip地址
</span><span style="color:#586e75;">     */
</span><span style="color:#586e75;">    public static String getIpAddress(HttpServletRequest request) {
</span><span style="color:#586e75;">        String ipAddress = request.getHeader(&quot;X-Real-IP&quot;);
</span><span style="color:#586e75;">        if (ipAddress == null || ipAddress.length() == 0 || &quot;unknown&quot;.equalsIgnoreCase(ipAddress)) {
</span><span style="color:#586e75;">            ipAddress = request.getHeader(&quot;x-forwarded-for&quot;);
</span><span style="color:#586e75;">        }
</span><span style="color:#586e75;">        if (ipAddress == null || ipAddress.length() == 0 || &quot;unknown&quot;.equalsIgnoreCase(ipAddress)) {
</span><span style="color:#586e75;">            ipAddress = request.getHeader(&quot;Proxy-Client-IP&quot;);
</span><span style="color:#586e75;">        }
</span><span style="color:#586e75;">        if (ipAddress == null || ipAddress.length() == 0 || &quot;unknown&quot;.equalsIgnoreCase(ipAddress)) {
</span><span style="color:#586e75;">            ipAddress = request.getHeader(&quot;WL-Proxy-Client-IP&quot;);
</span><span style="color:#586e75;">        }
</span><span style="color:#586e75;">        if (ipAddress == null || ipAddress.length() == 0 || &quot;unknown&quot;.equalsIgnoreCase(ipAddress)) {
</span><span style="color:#586e75;">            ipAddress = request.getHeader(&quot;HTTP_CLIENT_IP&quot;);
</span><span style="color:#586e75;">        }
</span><span style="color:#586e75;">        if (ipAddress == null || ipAddress.length() == 0 || &quot;unknown&quot;.equalsIgnoreCase(ipAddress)) {
</span><span style="color:#586e75;">            ipAddress = request.getHeader(&quot;HTTP_X_FORWARDED_FOR&quot;);
</span><span style="color:#586e75;">        }
</span><span style="color:#586e75;">        if (ipAddress == null || ipAddress.length() == 0 || &quot;unknown&quot;.equalsIgnoreCase(ipAddress)) {
</span><span style="color:#586e75;">            ipAddress = request.getRemoteAddr();
</span><span style="color:#586e75;">            if (&quot;127.0.0.1&quot;.equals(ipAddress) || &quot;0:0:0:0:0:0:0:1&quot;.equals(ipAddress)) {
</span><span style="color:#586e75;">                //根据网卡取本机配置的IP
</span><span style="color:#586e75;">                InetAddress inet = null;
</span><span style="color:#586e75;">                try {
</span><span style="color:#586e75;">                    inet = InetAddress.getLocalHost();
</span><span style="color:#586e75;">                } catch (UnknownHostException e) {
</span><span style="color:#586e75;">                    log.error(&quot;getIpAddress exception:&quot;, e);
</span><span style="color:#586e75;">                }
</span><span style="color:#586e75;">                assert inet != null;
</span><span style="color:#586e75;">                ipAddress = inet.getHostAddress();
</span><span style="color:#586e75;">            }
</span><span style="color:#586e75;">        }
</span><span style="color:#586e75;">        return StringUtils.substringBefore(ipAddress, &quot;,&quot;);
</span><span style="color:#586e75;">    }
</span><span style="color:#586e75;">
</span><span style="color:#586e75;">    private static DbSearcher searcher;
</span><span style="color:#586e75;">    private static Method method;
</span><span style="color:#586e75;">
</span><span style="color:#586e75;">    /**
</span><span style="color:#586e75;">     * 在服务启动时加载 ip2region.db 到内存中
</span><span style="color:#586e75;">     */
</span><span style="color:#586e75;">    @PostConstruct
</span><span style="color:#586e75;">    private void initIp2regionResource() throws Exception {
</span><span style="color:#586e75;">        InputStream inputStream = new ClassPathResource(&quot;/ip/ip2region.db&quot;).getInputStream();
</span><span style="color:#586e75;">        //将 ip2region.db 转为 ByteArray
</span><span style="color:#586e75;">        byte[] dbBinStr = FileCopyUtils.copyToByteArray(inputStream);
</span><span style="color:#586e75;">        DbConfig dbConfig = new DbConfig();
</span><span style="color:#586e75;">        searcher = new DbSearcher(dbConfig, dbBinStr);
</span><span style="color:#586e75;">        //二进制方式初始化 DBSearcher，需要使用基于内存的查找算法 memorySearch
</span><span style="color:#586e75;">        method = searcher.getClass().getMethod(&quot;memorySearch&quot;, String.class);
</span><span style="color:#586e75;">    }
</span><span style="color:#586e75;">
</span><span style="color:#586e75;">    /**
</span><span style="color:#586e75;">     * 获取ip地址的归属地
</span><span style="color:#586e75;">     */
</span><span>    </span><span style="color:#93a1a1;">public static </span><span style="color:#859900;">String </span><span style="color:#b58900;">getIpSource</span><span style="color:#657b83;">(</span><span style="color:#859900;">String </span><span style="color:#268bd2;">ipAddress</span><span style="color:#657b83;">) {
</span><span>        </span><span style="color:#859900;">if </span><span style="color:#657b83;">(</span><span>ipAddress </span><span style="color:#657b83;">== </span><span style="color:#b58900;">null </span><span style="color:#859900;">|| !Util</span><span>.</span><span style="color:#b58900;">isIpAddress</span><span style="color:#657b83;">(</span><span>ipAddress</span><span style="color:#657b83;">)) {
</span><span>            log.</span><span style="color:#b58900;">error</span><span style="color:#657b83;">(</span><span>&quot;</span><span style="color:#2aa198;">Error: Invalid ip address</span><span>&quot;</span><span style="color:#657b83;">)</span><span>;
</span><span>            </span><span style="color:#859900;">return </span><span>&quot;&quot;;
</span><span>        </span><span style="color:#657b83;">}
</span><span>        </span><span style="color:#859900;">try </span><span style="color:#657b83;">{
</span><span>            </span><span style="color:#859900;">DataBlock</span><span> dataBlock </span><span style="color:#657b83;">= (</span><span style="color:#859900;">DataBlock</span><span style="color:#657b83;">)</span><span> method.</span><span style="color:#b58900;">invoke</span><span style="color:#657b83;">(</span><span>searcher, ipAddress</span><span style="color:#657b83;">)</span><span>;
</span><span>            </span><span style="color:#859900;">String</span><span> ipInfo </span><span style="color:#657b83;">=</span><span> dataBlock.</span><span style="color:#b58900;">getRegion</span><span style="color:#657b83;">()</span><span>;
</span><span>            </span><span style="color:#859900;">if </span><span style="color:#657b83;">(</span><span style="color:#859900;">!StringUtils</span><span>.</span><span style="color:#b58900;">isEmpty</span><span style="color:#657b83;">(</span><span>ipInfo</span><span style="color:#657b83;">)) {
</span><span>                ipInfo </span><span style="color:#657b83;">=</span><span> ipInfo.</span><span style="color:#b58900;">replace</span><span style="color:#657b83;">(</span><span>&quot;</span><span style="color:#2aa198;">|0</span><span>&quot;, &quot;&quot;</span><span style="color:#657b83;">)</span><span>;
</span><span>                ipInfo </span><span style="color:#657b83;">=</span><span> ipInfo.</span><span style="color:#b58900;">replace</span><span style="color:#657b83;">(</span><span>&quot;</span><span style="color:#2aa198;">0|</span><span>&quot;, &quot;&quot;</span><span style="color:#657b83;">)</span><span>;
</span><span>                </span><span style="color:#859900;">return</span><span> ipInfo;
</span><span>            </span><span style="color:#657b83;">}
</span><span>        </span><span style="color:#657b83;">} </span><span style="color:#859900;">catch </span><span style="color:#657b83;">(</span><span style="color:#859900;">Exception </span><span style="color:#268bd2;">e</span><span style="color:#657b83;">) {
</span><span>            log.</span><span style="color:#b58900;">error</span><span style="color:#657b83;">(</span><span>&quot;</span><span style="color:#2aa198;">getCityInfo exception:</span><span>&quot;, e</span><span style="color:#657b83;">)</span><span>;
</span><span>        </span><span style="color:#657b83;">}
</span><span>        </span><span style="color:#859900;">return </span><span>&quot;&quot;;
</span><span>    </span><span style="color:#657b83;">}
</span><span>
</span><span>    </span><span style="color:#93a1a1;">public static </span><span style="color:#859900;">String </span><span style="color:#b58900;">getIpProvince</span><span style="color:#657b83;">(</span><span style="color:#859900;">String </span><span style="color:#268bd2;">ipSource</span><span style="color:#657b83;">) {
</span><span>        </span><span style="color:#859900;">String</span><span style="color:#93a1a1;">[]</span><span> strings </span><span style="color:#657b83;">=</span><span> ipSource.</span><span style="color:#b58900;">split</span><span style="color:#657b83;">(</span><span>&quot;</span><span style="color:#dc322f;">\\</span><span style="color:#2aa198;">|</span><span>&quot;</span><span style="color:#657b83;">)</span><span>;
</span><span>        </span><span style="color:#859900;">if </span><span style="color:#657b83;">(</span><span>strings[</span><span style="color:#6c71c4;">1</span><span>].</span><span style="color:#b58900;">endsWith</span><span style="color:#657b83;">(</span><span>&quot;</span><span style="color:#2aa198;">省</span><span>&quot;</span><span style="color:#657b83;">)) {
</span><span>            </span><span style="color:#859900;">return StringUtils</span><span>.</span><span style="color:#b58900;">substringBefore</span><span style="color:#657b83;">(</span><span>strings[</span><span style="color:#6c71c4;">1</span><span>], &quot;</span><span style="color:#2aa198;">省</span><span>&quot;</span><span style="color:#657b83;">)</span><span>;
</span><span>        </span><span style="color:#657b83;">}
</span><span>        </span><span style="color:#859900;">return</span><span> strings[</span><span style="color:#6c71c4;">1</span><span>];
</span><span>    </span><span style="color:#657b83;">}
</span><span>
</span><span>    </span><span style="color:#586e75;">/**
</span><span style="color:#586e75;">     * 获取访问设备
</span><span style="color:#586e75;">     */
</span><span style="color:#586e75;">    public static UserAgent getUserAgent(HttpServletRequest request) {
</span><span style="color:#586e75;">        return UserAgent.parseUserAgentString(request.getHeader(&quot;User-Agent&quot;));
</span><span style="color:#586e75;">    }
</span><span style="color:#586e75;">}
</span></code></pre>
<hr />
<h3 id="3-2-ding-yi-xian-liu-zhu-jie">3.2 定义限流注解<a class="zola-anchor" href="#3-2-ding-yi-xian-liu-zhu-jie" aria-label="Anchor link for: 3-2-ding-yi-xian-liu-zhu-jie">🔗</a></h3>
<p>为了使用方便，我这里选择了注解的方式，这样在使用的时候只需要在需要进行限流的请求<code>Controller</code>上添加一个注解即可。就像这样:</p>
<p><img src="https://images.waer.ltd/img/image-20221229211158557.png" alt="image-20221229211158557" /></p>
<blockquote>
<p>自定义的限流注解其实很简单，主要包含限流的Key，限流周期以及请求计数器。当然，这些数据都是完全可以自定义的，并没有什么约定俗成，具体工具自己的业务需要决定就好。</p>
</blockquote>
<pre data-lang="java" style="background-color:#002b36;color:#839496;" class="language-java "><code class="language-java" data-lang="java"><span style="color:#cb4b16;">import </span><span style="color:#859900;">java</span><span>.</span><span style="color:#859900;">lang</span><span>.</span><span style="color:#859900;">annotation</span><span>.</span><span style="color:#cb4b16;">*</span><span>;
</span><span style="color:#586e75;">/**
</span><span style="color:#586e75;"> * </span><span style="color:#859900;">@author</span><span style="color:#586e75;">: 八尺妖剑
</span><span style="color:#586e75;"> * @date: 2022/10/19 12:34
</span><span style="color:#586e75;"> * @email: ilikexff@gmail.com
</span><span style="color:#586e75;"> * @blog: https://www.waer.ltd
</span><span style="color:#586e75;"> * @Description: 自定义注解:接口限流
</span><span style="color:#586e75;"> */
</span><span>@</span><span style="color:#268bd2;">Documented
</span><span>@</span><span style="color:#268bd2;">Retention</span><span style="color:#657b83;">(</span><span style="color:#859900;">RetentionPolicy</span><span>.</span><span style="color:#cb4b16;">RUNTIME</span><span style="color:#657b83;">)
</span><span>@</span><span style="color:#268bd2;">Target</span><span style="color:#657b83;">(</span><span style="color:#859900;">ElementType</span><span>.</span><span style="color:#cb4b16;">METHOD</span><span style="color:#657b83;">)
</span><span style="color:#93a1a1;">public </span><span style="color:#268bd2;">@interface </span><span style="color:#b58900;">RateLimit </span><span style="color:#657b83;">{
</span><span>    </span><span style="color:#586e75;">/**
</span><span style="color:#586e75;">     * 限流的key
</span><span style="color:#586e75;">     */
</span><span style="color:#586e75;">    String key() default &quot;limit&quot;;
</span><span style="color:#586e75;">
</span><span style="color:#586e75;">    /**
</span><span style="color:#586e75;">     * 周期：单位秒
</span><span style="color:#586e75;">     * </span><span style="color:#859900;">@return
</span><span style="color:#586e75;">     */
</span><span style="color:#586e75;">    int cycles() default 5;
</span><span style="color:#586e75;">
</span><span style="color:#586e75;">    /**
</span><span style="color:#586e75;">     * 请求次数
</span><span style="color:#586e75;">     * </span><span style="color:#859900;">@return
</span><span style="color:#586e75;">     */
</span><span style="color:#586e75;">    int count() default 1;
</span><span style="color:#586e75;">}
</span></code></pre>
<hr />
<h3 id="3-3-zi-ding-yi-lan-jie-qi">3.3 自定义拦截器<a class="zola-anchor" href="#3-3-zi-ding-yi-lan-jie-qi" aria-label="Anchor link for: 3-3-zi-ding-yi-lan-jie-qi">🔗</a></h3>
<blockquote>
<p>这里使用到了拦截器，主要作用就是拦截处理所有的请求进行拦截，主要用到的<code>preHandle</code>方法。所有的限流逻辑都在这里实现。所以这部分挺重要的。</p>
</blockquote>
<pre data-lang="java" style="background-color:#002b36;color:#839496;" class="language-java "><code class="language-java" data-lang="java"><span style="color:#586e75;">/**
</span><span style="color:#586e75;"> * </span><span style="color:#859900;">@author</span><span style="color:#586e75;">: 八尺妖剑
</span><span style="color:#586e75;"> * @date: 2022/10/19 12:38
</span><span style="color:#586e75;"> * @email: ilikexff@gmail.com
</span><span style="color:#586e75;"> * @blog: https://www.waer.ltd
</span><span style="color:#586e75;"> * @Description: 拦截器:处理接口限流
</span><span style="color:#586e75;"> */
</span><span>@</span><span style="color:#268bd2;">Component
</span><span style="color:#93a1a1;">public </span><span style="color:#268bd2;">class </span><span style="color:#b58900;">RateLimitInterceptor </span><span style="color:#859900;">implements </span><span style="color:#268bd2;">HandlerInterceptor </span><span style="color:#657b83;">{
</span><span>    @</span><span style="color:#268bd2;">Resource
</span><span>    </span><span style="color:#93a1a1;">private </span><span style="color:#859900;">RedisTemplate</span><span>&lt;</span><span style="color:#859900;">String</span><span>,</span><span style="color:#859900;">Integer</span><span>&gt; redisTemplate;
</span><span>    @</span><span style="color:#268bd2;">Autowired
</span><span>    </span><span style="color:#93a1a1;">private </span><span style="color:#859900;">EmailUtils </span><span>emailUtils;
</span><span>    @</span><span style="color:#268bd2;">Override
</span><span>    </span><span style="color:#93a1a1;">public </span><span style="color:#268bd2;">boolean </span><span style="color:#b58900;">preHandle</span><span style="color:#657b83;">(</span><span style="color:#859900;">HttpServletRequest </span><span style="color:#268bd2;">request</span><span>, </span><span style="color:#859900;">HttpServletResponse </span><span style="color:#268bd2;">response</span><span>, </span><span style="color:#859900;">Object </span><span style="color:#268bd2;">handler</span><span style="color:#657b83;">) </span><span style="color:#859900;">throws Exception </span><span style="color:#657b83;">{
</span><span>        </span><span style="color:#586e75;">// 如果请求的是方法，则需要做校验
</span><span>        </span><span style="color:#859900;">if </span><span style="color:#657b83;">(</span><span>handler </span><span style="color:#859900;">instanceof HandlerMethod</span><span style="color:#657b83;">) {
</span><span>            </span><span style="color:#859900;">HandlerMethod</span><span> handlerMethod </span><span style="color:#657b83;">= (</span><span style="color:#859900;">HandlerMethod</span><span style="color:#657b83;">)</span><span> handler;
</span><span>            </span><span style="color:#586e75;">// 获取目标方法上是否有指定注解
</span><span>            </span><span style="color:#859900;">RateLimit</span><span> rateLimit </span><span style="color:#657b83;">=</span><span> handlerMethod.</span><span style="color:#b58900;">getMethodAnnotation</span><span style="color:#657b83;">(</span><span style="color:#859900;">RateLimit</span><span>.</span><span style="color:#d33682;">class</span><span style="color:#657b83;">)</span><span>;
</span><span>            </span><span style="color:#859900;">if </span><span style="color:#657b83;">(</span><span>rateLimit </span><span style="color:#657b83;">== </span><span style="color:#b58900;">null</span><span style="color:#657b83;">) {
</span><span>                </span><span style="color:#586e75;">//说明目标方法上没有 RateLimit 注解
</span><span>                </span><span style="color:#859900;">return </span><span style="color:#b58900;">true</span><span>;
</span><span>            </span><span style="color:#657b83;">}
</span><span>            </span><span style="color:#586e75;">// 说明目标方法上有 RateLimit 注解，所以需要校验这个请求是不是在刷接口
</span><span>            </span><span style="color:#586e75;">// 获取请求IP地址
</span><span>            </span><span style="color:#859900;">String</span><span> ip </span><span style="color:#657b83;">= </span><span style="color:#859900;">IpUtils</span><span>.</span><span style="color:#b58900;">getIpAddress</span><span style="color:#657b83;">(</span><span>request</span><span style="color:#657b83;">)</span><span>;
</span><span>            </span><span style="color:#586e75;">// 请求url路径
</span><span>            </span><span style="color:#859900;">String</span><span> uri </span><span style="color:#657b83;">=</span><span> request.</span><span style="color:#b58900;">getRequestURI</span><span style="color:#657b83;">()</span><span>;
</span><span>            </span><span style="color:#586e75;">//存到redis中的key
</span><span>            </span><span style="color:#859900;">String</span><span> key </span><span style="color:#657b83;">= </span><span>&quot;</span><span style="color:#2aa198;">RateLimit:</span><span>&quot; </span><span style="color:#657b83;">+</span><span> ip </span><span style="color:#657b83;">+ </span><span>&quot;</span><span style="color:#2aa198;">:</span><span>&quot; </span><span style="color:#657b83;">+</span><span> uri;
</span><span>            </span><span style="color:#586e75;">// 缓存中存在key，在限定访问周期内已经调用过当前接口
</span><span>            </span><span style="color:#859900;">if </span><span style="color:#657b83;">(</span><span>redisTemplate.</span><span style="color:#b58900;">hasKey</span><span style="color:#657b83;">(</span><span>key</span><span style="color:#657b83;">)) {
</span><span>                </span><span style="color:#586e75;">// 访问次数自增1
</span><span>                redisTemplate.</span><span style="color:#b58900;">opsForValue</span><span style="color:#657b83;">()</span><span>.</span><span style="color:#b58900;">increment</span><span style="color:#657b83;">(</span><span>key, </span><span style="color:#6c71c4;">1</span><span style="color:#657b83;">)</span><span>;
</span><span>                </span><span style="color:#859900;">Integer</span><span> count </span><span style="color:#657b83;">=</span><span> redisTemplate.</span><span style="color:#b58900;">opsForValue</span><span style="color:#657b83;">()</span><span>.</span><span style="color:#b58900;">get</span><span style="color:#657b83;">(</span><span>key</span><span style="color:#657b83;">)</span><span>;
</span><span>                </span><span style="color:#586e75;">// 超出访问次数限制
</span><span>                </span><span style="color:#859900;">if </span><span style="color:#657b83;">(</span><span>count </span><span style="color:#657b83;">&gt;</span><span> rateLimit.</span><span style="color:#b58900;">count</span><span style="color:#657b83;">()) {
</span><span>                    </span><span style="color:#859900;">String</span><span> from </span><span style="color:#657b83;">= </span><span style="color:#859900;">IpUtils</span><span>.</span><span style="color:#b58900;">getIpSource</span><span style="color:#657b83;">(</span><span>ip</span><span style="color:#657b83;">)</span><span>;
</span><span>                    </span><span style="color:#859900;">EmailDTO</span><span> emailDTO </span><span style="color:#657b83;">= </span><span style="color:#b58900;">SendEmailForRateLimit</span><span style="color:#657b83;">(</span><span>ip,uri,from</span><span style="color:#657b83;">)</span><span>;
</span><span>                    </span><span style="color:#859900;">CompletableFuture</span><span>.</span><span style="color:#b58900;">supplyAsync</span><span style="color:#657b83;">(()</span><span style="color:#268bd2;">-&gt;</span><span style="color:#657b83;">{
</span><span>                        </span><span style="color:#859900;">return</span><span> count</span><span style="color:#657b83;">==</span><span style="color:#6c71c4;">50 </span><span style="color:#859900;">? </span><span style="color:#b58900;">true </span><span style="color:#859900;">: </span><span style="color:#b58900;">false</span><span>;
</span><span>                    </span><span style="color:#657b83;">})</span><span>.</span><span style="color:#b58900;">thenApplyAsync</span><span style="color:#657b83;">(</span><span style="color:#268bd2;">num-&gt;</span><span style="color:#859900;">CompletableFuture</span><span>.</span><span style="color:#b58900;">supplyAsync</span><span style="color:#657b83;">(() </span><span style="color:#268bd2;">-&gt; </span><span style="color:#657b83;">{
</span><span>                        </span><span style="color:#586e75;">//System.out.println(&quot;num:&quot; + num);
</span><span>                        </span><span style="color:#859900;">if</span><span style="color:#657b83;">(</span><span>num</span><span style="color:#657b83;">) {
</span><span>                            emailUtils.</span><span style="color:#b58900;">sendHtmlMail</span><span style="color:#657b83;">(</span><span>emailDTO</span><span style="color:#657b83;">)</span><span>;
</span><span>                        </span><span style="color:#657b83;">}
</span><span>                        </span><span style="color:#859900;">return </span><span>&quot;</span><span style="color:#2aa198;">邮件发送完成</span><span>&quot;;
</span><span>                    </span><span style="color:#657b83;">}))</span><span>;
</span><span>                    </span><span style="color:#859900;">throw  new BizException</span><span style="color:#657b83;">(</span><span style="color:#859900;">StatusCodeEnum</span><span>.</span><span style="color:#cb4b16;">RATE_LIMIT_REQUEST</span><span style="color:#657b83;">)</span><span>;
</span><span>                </span><span style="color:#657b83;">}
</span><span>                </span><span style="color:#586e75;">// 未超出访问次数限制，不进行任何操作，返回true
</span><span>            </span><span style="color:#657b83;">} </span><span style="color:#859900;">else </span><span style="color:#657b83;">{
</span><span>                </span><span style="color:#586e75;">// 第一次设置数据,过期时间为注解确定的访问周期
</span><span>                redisTemplate.</span><span style="color:#b58900;">opsForValue</span><span style="color:#657b83;">()</span><span>.</span><span style="color:#b58900;">set</span><span style="color:#657b83;">(</span><span>key, </span><span style="color:#6c71c4;">1</span><span>, rateLimit.</span><span style="color:#b58900;">cycles</span><span style="color:#657b83;">()</span><span>, </span><span style="color:#859900;">TimeUnit</span><span>.</span><span style="color:#cb4b16;">SECONDS</span><span style="color:#657b83;">)</span><span>;
</span><span>            </span><span style="color:#657b83;">}
</span><span>            </span><span style="color:#859900;">return </span><span style="color:#b58900;">true</span><span>;
</span><span>        </span><span style="color:#657b83;">}
</span><span>        </span><span style="color:#586e75;">//如果请求的不是方法，直接放行
</span><span>        </span><span style="color:#859900;">return </span><span style="color:#b58900;">true</span><span>;
</span><span>    </span><span style="color:#657b83;">}
</span></code></pre>
<blockquote>
<p>代码中已经写了详细的注释，所以就不再具体展开，需要注意的是，其中涉及到邮件发送的部分是我自己增加的一个安全提醒的部分逻辑，所以这部分可以忽略掉，不算在限流逻辑中也是没有任何毛病的。</p>
</blockquote>
<hr />
<h2 id="4-shi-ji-shi-yong-zhi-hou-de-xiao-guo">4.实际使用之后的效果<a class="zola-anchor" href="#4-shi-ji-shi-yong-zhi-hou-de-xiao-guo" aria-label="Anchor link for: 4-shi-ji-shi-yong-zhi-hou-de-xiao-guo">🔗</a></h2>
<p>到这一步，所有的工作都完成了，前面也提到过使用是非常简单的，我们只需要在要进行限流的请求方法上加上注解<code>@RateLimit(cycles = 125,count = 3)</code>即可，至于括号内的限流参数，那就根据自己的需求设置了，比如我这里写的就是125秒内同一个IP只能进行3次请求，否则就会触发限流，请求拒绝。</p>
<p><strong>正常请求</strong></p>
<p><img src="https://images.waer.ltd/img/image-20221229214108308.png" alt="image-20221229214108308" /></p>
<p><strong>请求限流</strong></p>
<p><img src="https://images.waer.ltd/img/image-20221229214200435.png" alt="image-20221229214200435" /></p>
<p><strong>Redis中记录的数据</strong></p>
<p><img src="https://images.waer.ltd/img/image-20221229214335152.png" alt="image-20221229214335152" /></p>
<blockquote>
<p>注意，限流触发的提示信息建议自己写一个，我承认，我自己这个提示确实不太友好，这主要是当时被对面搞那么一出，就很气人，所以在语言提示上就有些不够友好，如果需要自定义，只需要修改下面的常量数据就可。</p>
</blockquote>
<p><img src="https://images.waer.ltd/img/image-20221229212951790.png" alt="image-20221229212951790" /></p>
<hr />
<h2 id="5-guan-yu-ji-shu-qi-xian-liu-fang-an-de-yi-xie-zong-jie">5.关于计数器限流方案的一些总结<a class="zola-anchor" href="#5-guan-yu-ji-shu-qi-xian-liu-fang-an-de-yi-xie-zong-jie" aria-label="Anchor link for: 5-guan-yu-ji-shu-qi-xian-liu-fang-an-de-yi-xie-zong-jie">🔗</a></h2>
<p>通过上面一波湿滑操作，我们已经以通过计数器这种方式具体应用到了实际的项目中，但这并不是故事的结束，每一种方法都有它独到的优势，自然也会有自己的不足，对于计数器实现的限流方案，其实还是有不少问题的。</p>
<p>考虑下面这种情况:</p>
<blockquote>
<p>​	假设对于某一些接口的需求是每分钟允许的请求上限是100次，如果某用户在最后那第59秒最后几毫秒瞬间直接给你来100个请求，当这一秒结束之后，计数器完成清零工作，此时该用户在下一秒的时候又给你整100个请求过来，啪一下就过来了，很快啊，那么1秒内这个很皮的用户就发送了2倍的请求，显然在这个情况下，一切也都是符合计数器限流原理的。</p>
<p>​	这就是该方法的缺陷(<strong>不能很好的处理时间单位的边界</strong>)，这种情况的存在，可能会导致系统一不小心就承受了太多，甚至击穿系统，所以这也是为什么还有其他几种方案的原因之一。</p>
</blockquote>
<p>至此就完成了一次接口限流的操作实践。最后，<strong>纸上得来终觉浅啊哥</strong>！</p>

      
    </div><!--./card-body-->

    <div class="card-footer">
      <div class="columns">
        <div class="column col-9 col-sm-7">
          <div class="taxonomies text-left">
            

    
          </div>
        </div><!--./col-6-->
        
        </div><!--./columns-->
    </div><!--./card-footer-->
</div><!--./card-->
</div>
              <div id="sidebar" class="column col-4 col-md-12">
                <div class="sidebar-content">
                  
                  
<div class="sidebar-widget">
  <div class="tile">
    <div class="tile-icon">
      <figure class="avatar avatar-xl">
        <img src="https://ilikexff.cn/avatar.png" alt="author avatar image">
      </figure>
    </div>
    <div class="tile-content">
      <p class="tile-title" style="font-weight: 600;">慕予</p>
      <p class="tile-subtitle">热爱编程，专注于技术分享和学习</p>
    </div>
</div><!--./tile-->
</div>

                  
                  
<div class="sidebar-widget">
  欢迎来到<strong>慕予博客</strong>！这里分享技术文章和编程心得。
</div><!-- end text widget -->

                  

                  </div><!--./sidebar-content-->
              </div>
            </div>
            
          </section>
        </section></section>
<section class="container grid-xl">
<ul class="pagination paginator">
  
  
</ul>
</section>
</div><!-- ./page-wrapper -->

    
<div class="mobile-container">
        <div class="overlay" id="overlay">
            <div style="padding: 1rem;">
              
<a class="site-logo" href="https:&#x2F;&#x2F;ilikexff.cn">
  
  <div class="col-mx-auto">
    <figure style="margin: 8px">
      <img class="img-responsive"
           style="max-height: 45px"
           alt="frontmatter image"
           src="https://ilikexff.cn/./logo.svg">
    </figure>
  </div>
  
</a>

            </div>
            <nav class="overlay-menu">
              

<ul class="tree treemenu treemenu-root"><li class="tree-empty">
      <span class="toggler"></span>
      <a href="https://ilikexff.cn/tags">标签</a>
    </li><li class="tree-empty">
      <span class="toggler"></span>
      <a href="https://ilikexff.cn/categories">分类</a>
    </li><li class="tree-empty">
      <span class="toggler"></span>
      <a href="https://ilikexff.cn/about">关于</a>
    </li></ul>


              </nav>
        </div>
    </div>

<script type="text/javascript">
  var overlay = document.getElementById('overlay');
  var toggle = document.getElementById('toggle');

  function openOverlay(){
      // Open overlay
      if (overlay.classList.contains("open")) {
          overlay.classList.remove("open");
      }
      else {
          overlay.classList.add("open");
      }

      // Button transition
      if (toggle.classList.contains("active")) {
          toggle.classList.remove("active");
      }
      else {
          toggle.classList.add("active");
      }
    }
</script>

<section id="footer" class="bg-gray">
  <div class="container grid-xl">
    


    <div class="columns">
      
      <div class="column col-6 col-lg-12 col-mx-auto" style="text-align: center;">
        简单是效率的灵魂 | 黔ICP备2021010295号
      </div>
      
      <div class="column col-6 col-lg-12 col-mx-auto" style="text-align: center;">
        Made by <a href="https://github.com/gicrisf/">gicrisf</a> -
        <strong>Zhuia</strong>&nbsp;<a href="https://github.com/gicrisf/zhuia">source code</a>
        is licensed under <a href="http://opensource.org/licenses/mit-license.php" target="_blank">MIT</a>.
      </div>
    </div>
  </div>
</section>
</body>
</html>
