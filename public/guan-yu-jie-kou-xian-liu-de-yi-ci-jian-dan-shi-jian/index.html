<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>慕予博客</title>
  <script src="https://cdn.jsdelivr.net/npm/js-cookie@3.0.5/dist/js.cookie.min.js"
    integrity="sha256-WCzAhd2P6gRJF9Hv3oOOd+hFJi/QJbv+Azn4CGB8gfY=" crossorigin="anonymous" defer></script>
  <script src="/js/index.js" defer></script>
  <script src="/js/prompt.js" defer></script>
  <script src="/js/keyboard.js" defer></script>
  <script src="/js/tab.js" defer></script>
  <script src="/js/commands.js" defer></script>
  <script src="/js/config.js" defer></script><script src="/config.js"></script><link rel="stylesheet" href="/css/base.css"><link rel="stylesheet" href="style.css"><link rel="stylesheet" href="/css/page.css"></head><body onkeydown="exec(event)" style="background-image: url(&#x27;&#x2F;assets&#x2F;bg.jpg&#x27;); "><main>
      <div class="files" id="files" tabindex="0">
<ul>

  <li class="file">
    <span><a href='https://ilikexff.cn/8-kuan-rang-ni-kai-fa-qi-fei-de-intellijidea-cha-jian/'
      tabindex="-2">  8款让你开发起飞的IntellijIDEA插件</a></span>
  </li><li class="file">
    <span><a href='https://ilikexff.cn/aop-jie-mi-qie-mian-bian-cheng-de-zong-he-zhi-nan/'
      tabindex="-3">  AOP揭秘：切面编程的综合指南</a></span>
  </li><li class="file">
    <span><a href='https://ilikexff.cn/c-you-xi-kai-fa-ji-chu-mei-ju-pian-yi-wu-fan-wei-mei-ju/'
      tabindex="-4">  C++游戏开发基础-枚举篇一：无范围枚举</a></span>
  </li><li class="file">
    <span><a href='https://ilikexff.cn/c-you-xi-kai-fa-ji-chu-std-optional/'
      tabindex="-5">  C++游戏开发基础-深入解析std::optional</a></span>
  </li><li class="file">
    <span><a href='https://ilikexff.cn/c-you-xi-kai-fa-ji-chu-shen-ru-jie-xi-thiszhi-zhen-de-ying-yong-yu-ji-qiao/'
      tabindex="-6">  C++游戏开发基础-深入解析this指针的应用与技巧</a></span>
  </li><li class="file">
    <span><a href='https://ilikexff.cn/c-you-xi-kai-fa-ji-chu-fu-zhi-gou-zao-han-shu/'
      tabindex="-7">  C++游戏开发基础-深入解析复制构造函数</a></span>
  </li><li class="file">
    <span><a href='https://ilikexff.cn/c-you-xi-kai-fa-ji-chu-lei-mo-ban-he-can-shu-tui-dao-zhi-nan/'
      tabindex="-8">  C++游戏开发基础-类模版和参数推导指南</a></span>
  </li><li class="file">
    <span><a href='https://ilikexff.cn/dockerbi-zhi-bi-hui/'
      tabindex="-9">  Docker必知必会</a></span>
  </li><li class="file">
    <span><a href='https://ilikexff.cn/githithub-xiao-ce/'
      tabindex="-10">  GitGitHub小册</a></span>
  </li><li class="file">
    <span><a href='https://ilikexff.cn/google-hacking/'
      tabindex="-11">  Google Hacking</a></span>
  </li><li class="file">
    <span><a href='https://ilikexff.cn/googleguan-fang-ti-shi-gong-cheng-bai-pi-shu-zhong-wen-yi-ben/'
      tabindex="-12">  Google官方《提示工程白皮书（中文译本）》</a></span>
  </li><li class="file">
    <span><a href='https://ilikexff.cn/idea-dai-ma-bu-quan-ti-shi-gong-neng-xiao-shi-de-ji-chong-jie-jue-fang-an-re-geng-ban/'
      tabindex="-13">  IDEA代码补全&amp;提示功能消失的几种解决方案(热更版)</a></span>
  </li><li class="file">
    <span><a href='https://ilikexff.cn/idea-chen-jin-shi-bian-cheng-ti-yan/'
      tabindex="-14">  IDEA沉浸式编程体验</a></span>
  </li><li class="file">
    <span><a href='https://ilikexff.cn/java-han-shu-shi-bian-cheng/'
      tabindex="-15">  Java函数式编程</a></span>
  </li><li class="file">
    <span><a href='https://ilikexff.cn/java-ji-he-yuan-ma-qian-xi/'
      tabindex="-16">  Java集合源码浅析</a></span>
  </li><li class="file">
    <span><a href='https://ilikexff.cn/mysql-shi-wu-te-xing-yu-ge-chi-ji-bie-xiang-jie/'
      tabindex="-17">  MySQL_事务特性与隔离级别详解</a></span>
  </li><li class="file">
    <span><a href='https://ilikexff.cn/ocao-zuo-fu-shi-xian-mei-ju-de-shu-ru-shu-chu/'
      tabindex="-18">  O操作符,实现枚举的输入输出</a></span>
  </li><li class="file">
    <span><a href='https://ilikexff.cn/prdsuan-fa-ting-shuo-ni-xiang-ping-yun-qi-chou-yi-ke-rong-yao-shui-jing/'
      tabindex="-19">  PRD算法：听说你想凭运气抽一颗荣耀水晶?</a></span>
  </li><li class="file">
    <span><a href='https://ilikexff.cn/picgo-pei-zhi-ge-chong-tu-chuang/'
      tabindex="-20">  PicGo配置各种图床</a></span>
  </li><li class="file">
    <span><a href='https://ilikexff.cn/redis-bi-zhi-bi-hui/'
      tabindex="-21">  Redis必知必会</a></span>
  </li><li class="file">
    <span><a href='https://ilikexff.cn/rust-zhong-de-move-yu-yi-sui-bi/'
      tabindex="-22">  Rust中的move语义随笔</a></span>
  </li><li class="file">
    <span><a href='https://ilikexff.cn/ssm-kuang-jia-shi-xian-ji-cheng-duan-xin-yan-zheng-ma-gong-neng/'
      tabindex="-23">  SSM框架实现集成短信验证码功能</a></span>
  </li><li class="file">
    <span><a href='https://ilikexff.cn/slf4jyu-logbackshi-yong-zhi-nan-ji-yu-gradle/'
      tabindex="-24">  Slf4j与Logback实用指南(基于Gradle)</a></span>
  </li><li class="file">
    <span><a href='https://ilikexff.cn/spring-security5-xdao-spring-security6-xde-qian-yi/'
      tabindex="-25">  Spring Security5.x到Spring Security6.x的迁移</a></span>
  </li><li class="file">
    <span><a href='https://ilikexff.cn/springboot-webkai-fa-jing-jie/'
      tabindex="-26">  SpringBoot Web开发精解</a></span>
  </li><li class="file">
    <span><a href='https://ilikexff.cn/springsecurity/'
      tabindex="-27">  SpringSecurity</a></span>
  </li><li class="file">
    <span><a href='https://ilikexff.cn/unity6xia-jia-zhong-guo-qu-tuan-jie-yin-qing-jie-bang-zhe-shi-fen-lie-huan-shi-ben-di-hua-de-kai-shi/'
      tabindex="-28">  Unity6下架中国区，团结引擎接棒：这是分裂，还是本地化的开始？</a></span>
  </li><li class="file">
    <span><a href='https://ilikexff.cn/vim-cong-0-dao-1-da-zao-quan-yu-yan-zhi-chi-de-mo-neng-bian-ji-qi-yu-fa-pian/'
      tabindex="-29">  Vim从0到1打造全语言支持的万能编辑器-语法篇</a></span>
  </li><li class="file">
    <span><a href='https://ilikexff.cn/vim-tiao-tou-powershell-pian/'
      tabindex="-30">  Vim折腾之 PowerShell篇</a></span>
  </li><li class="file">
    <span><a href='https://ilikexff.cn/c-you-xi-kai-fa-ji-chu-di-zhi-chuan-di-xiang-jie/'
      tabindex="-31">  [C++游戏开发基础]:地址传递详解</a></span>
  </li><li class="file">
    <span><a href='https://ilikexff.cn/c-you-xi-kai-fa-ji-chu-yin-yong-fan-hui-he-di-zhi-fan-hui/'
      tabindex="-32">  [C++游戏开发基础]:引用返回和地址返回</a></span>
  </li><li class="file">
    <span><a href='https://ilikexff.cn/c-you-xi-kai-fa-ji-chu-zhi-zhen-he-const/'
      tabindex="-33">  [C++游戏开发基础]:指针和const</a></span>
  </li><li class="file">
    <span><a href='https://ilikexff.cn/c-you-xi-kai-fa-ji-chu-shu-ju-feng-zhuang-yin-cang-de-hao-chu/'
      tabindex="-34">  [C++游戏开发基础]:数据封装(隐藏)的好处</a></span>
  </li><li class="file">
    <span><a href='https://ilikexff.cn/c-you-xi-kai-fa-ji-chu-gou-zao-han-shu-qian-xi-8000zi/'
      tabindex="-35">  [C++游戏开发基础]:构造函数浅析(8000字)</a></span>
  </li><li class="file">
    <span><a href='https://ilikexff.cn/c-you-xi-kai-fa-ji-chu-li-jie-kong-zhi-zhen/'
      tabindex="-36">  [C++游戏开发基础]:理解空指针</a></span>
  </li><li class="file">
    <span><a href='https://ilikexff.cn/c-you-xi-kai-fa-ji-chu-lei-zhong-de-fang-wen-han-shu/'
      tabindex="-37">  [C++游戏开发基础]:类中的访问函数</a></span>
  </li><li class="file">
    <span><a href='https://ilikexff.cn/c-you-xi-kai-fa-ji-chu-zhi-zhen-de-ji-ben-gai-nian-li-jie/'
      tabindex="-38">  [C++游戏开发基础]指针的基本概念理解</a></span>
  </li><li class="file">
    <span><a href='https://ilikexff.cn/fanatical-wu-yue-feng-kuang-te-hui-wei-ni-de-steam-ku-jia-dian-liao/'
      tabindex="-39">  _Fanatical 五月疯狂特惠：为你的 Steam 库加点料！</a></span>
  </li><li class="file">
    <span><a href='https://ilikexff.cn/rust-kai-yuan-mi-ma-gong-ju-xpwd-zhong-wen-ban-bian-geng-ri-zhi/'
      tabindex="-40">  _Rust开源密码工具xpwd中文版变更日志</a></span>
  </li><li class="file">
    <span><a href='https://ilikexff.cn/readme/'
      tabindex="-41">  readme</a></span>
  </li><li class="file">
    <span><a href='https://ilikexff.cn/wblog-bo-ke-xian-shang-bu-shu/'
      tabindex="-42">  wblog博客线上部署</a></span>
  </li><li class="file">
    <span><a href='https://ilikexff.cn/shang-gu-shen-qi-vim-su-cheng-bei-wang-lu/'
      tabindex="-43">  上古神器_Vim速成备忘录</a></span>
  </li><li class="file">
    <span><a href='https://ilikexff.cn/mian-fei-ji-huo-quan-ban-ben-typora-zui-xin-ban-wei-li/'
      tabindex="-44">  免费激活全版本Typora，最新版为例</a></span>
  </li><li class="file">
    <span><a href='https://ilikexff.cn/guan-yu-lombokxian-wei-ren-zhi-de-ji-ge-qi-ji-yin-qiao/'
      tabindex="-45">  关于Lombok鲜为人知的几个奇技淫巧</a></span>
  </li><li class="file">
    <span><a class="selected"href='https://ilikexff.cn/guan-yu-jie-kou-xian-liu-de-yi-ci-jian-dan-shi-jian/'
      tabindex="-46">  关于接口限流的一次简单实践</a></span>
  </li><li class="file">
    <span><a href='https://ilikexff.cn/tu-jie-er-jin-zhi/'
      tabindex="-47">  图解二进制</a></span>
  </li><li class="file">
    <span><a href='https://ilikexff.cn/ru-he-xie-de-yi-shou-you-ya-gui-fan-de-springboot-jie-kou/'
      tabindex="-48">  如何写得一手优雅规范的SpringBoot 接口？</a></span>
  </li><li class="file">
    <span><a href='https://ilikexff.cn/kai-fa-bi-hui-xi-lie-jwtqian-tan/'
      tabindex="-49">  开发必会系列_JWT浅谈</a></span>
  </li><li class="file">
    <span><a href='https://ilikexff.cn/ji-qiao-jiu-shi-xiao-lu-chatgpt-diao-jiao-zhi-bei/'
      tabindex="-50">  技巧就是效率，ChatGPT调教指北</a></span>
  </li><li class="file">
    <span><a href='https://ilikexff.cn/ti-sheng-intellij-kai-fa-xiao-lu-zhe-kuan-dai-ma-tu-ding-cha-jian-codepins-zhi-de-yi-shi/'
      tabindex="-51">  提升 IntelliJ 开发效率？这款代码图钉插件 CodePins 值得一试</a></span>
  </li><li class="file">
    <span><a href='https://ilikexff.cn/ti-wen-de-zhi-hui-zhuan-zai/'
      tabindex="-52">  提问的智慧转载</a></span>
  </li><li class="file">
    <span><a href='https://ilikexff.cn/xiao-lu-gong-ju-markdown/'
      tabindex="-53">  效率工具Markdown</a></span>
  </li><li class="file">
    <span><a href='https://ilikexff.cn/wu-wei-bing-fa-rust-sheng-ming-zhou-qi-qian-tan/'
      tabindex="-54">  无畏并发_Rust 生命周期浅谈</a></span>
  </li><li class="file">
    <span><a href='https://ilikexff.cn/you-xi-kai-fa-yu-de-bei-sai-er-qu-xian-gan-shou-si-hua-de-shu-xue-zhi-mei/'
      tabindex="-55">  游戏开发与的贝塞尔曲线_感受丝滑的数学之美</a></span>
  </li><li class="file">
    <span><a href='https://ilikexff.cn/you-xi-kai-fa-bi-bei-gao-xiao-de-aabb-qiu-ti-he-obb-peng-zhuang-jian-ce-suan-fa/'
      tabindex="-56">  游戏开发必备：高效的 AABB、球体和 OBB 碰撞检测算法</a></span>
  </li><li class="file">
    <span><a href='https://ilikexff.cn/you-xi-suan-fa-ji-chu-a-xun-lu-suan-fa-chi-xu-wei-hu/'
      tabindex="-57">  游戏算法基础-深入解析A*寻路算法</a></span>
  </li><li class="file">
    <span><a href='https://ilikexff.cn/du-li-you-xi-kai-fa-zhe-gong-ju-xiang-2025jing-xuan-tui-jian-yu-shi-yong-zhi-nan/'
      tabindex="-58">  独立游戏开发者工具箱：2025精选推荐与实用指南</a></span>
  </li><li class="file">
    <span><a href='https://ilikexff.cn/xu-huan-yin-qing-you-xi-kai-fa-xi-lie-zhuan-ti-guan-fang-bian-ma-biao-zhun-huo-gui-yue/'
      tabindex="-59">  虚幻引擎游戏开发系列专题-官方编码标准或规约</a></span>
  </li><li class="file">
    <span><a href='https://ilikexff.cn/xiang-jie-she-ji-mo-shi-dan-li-de-jin-hua-zhi-lu/'
      tabindex="-60">  详解设计模式_单例的进化之路</a></span>
  </li><li class="file">
    <span><a href='https://ilikexff.cn/xie-e-de-fei-chang-liang-quan-ju-bian-liang/'
      tabindex="-61">  邪恶的非常量全局变量</a></span>
  </li>
</ul>
</div>
      <div class="viewer page" id="viewer" tabindex="0">
        <div class="tab">
<div class="file-manager" onclick='document.getElementById("files").classList.toggle("open"); document.getElementById("content").classList.toggle("close")'> </div>
<ul id="tabs">
</ul>


</div>
        <div class="content" id="content"><h2 id="1-xie-zhe-pian-wen-zhang-de-lai-you">1.写这篇文章的来由</h2>
<p>有一段时间里，博客总是三天两头被打，其中就遇到了恶意刷接口的手段，对方明显使用的代码IP，由于博客并没有做这方面的措施，加上被大量盗刷的接口刚好是数据量最大的一篇文章数据，所以不出意外的，博客没多久就崩了。服务器状态也是各种异常。所以吃一堑长一智吧算是，我也没想到<strong>面对</strong>一个个人小破站，<strong>对面</strong>也是饥不择食….真<strong>大黑客</strong>啊兄弟们！！！</p>
<p><img src="https://images.waer.ltd/img/ERROR.jpg" alt="ERROR" loading="lazy" decoding="async" /></p>
<hr />
<h2 id="">2.接口限流的常见手段</h2>
<p>​	现在来说，做限流的各种方案其实已经相对很成熟了，这里也是大致列举了几种常用的解决方案，但不会全部都细说。</p>
<p>毕竟很多都还是自己没有实际使用过的，光搞理论是没什么意义的，所以后续有时间打算一个个揪出来细搞，起码得到用过了再写篇文章总结一下吧。</p>
<blockquote>
<p>Java中常用的限流解决方案:</p>
</blockquote>
<ul>
<li><strong>计数器</strong></li>
<li>滑动窗口</li>
<li>漏桶</li>
<li>令牌桶</li>
<li><code>Redis+Lua</code>分布式限流</li>
</ul>
<p>由于我博客采用的就是计数器方案，所以这里主要记录一下整个大致的限流原理以及实践过程。</p>
<p>上面几种方案中，计数器算是最简单的限流算法了。原理就是在指定的时间间隔内，对接口的请求次数进行限制，具体到我的博客为例，我是针对每个<code>IP</code>进行的请求限制，对请求进行计数，判断请求数量与阈值的情况，决定是否需要限流，每个<code>IP</code>触发限流之后会有一定的时间周期，计数器到时清零即可。</p>
<p>这就是计数器限流基本的原理。具体的实现上，我选用了<code>Redis</code>作为了计数限流的中间件，所以也可以理解为，这是<code>Redis+</code>计数器的一种实现方式。具体执行的逻辑如下:</p>
<blockquote>
<ul>
<li>设置好计数器<code>count</code>，每过一次请求计数器就<code>+1</code>，同时记录对应的请求<code>IP</code>；</li>
<li>当下一个请求到来之际，首先通过<code>IP</code>判断对应的计数器是否达到了限流的频次，以及本次请求是否还在设定的请求周期内；</li>
<li>如果请求已触发限流阈值，则针对该<code>IP</code>开启限流，后面的所有请求均直接拒绝。</li>
<li>当被限流<code>IP</code>达到时间周期满之后，将<code>count</code>重置，计数器进入下一轮的就绪状态。</li>
</ul>
</blockquote>
<p>原理也是蛮简单的，我也是蛮喜欢这种方式的(<strong>床言床语</strong>😀）。下面开始具体的实操部分。</p>
<hr />
<h2 id="-1">3.计数器限流实践</h2>
<p>首先确定实现的具体方案，上面说了，我这里用的是<code>Redis</code>作为限流计数器的记录以及限流状态的重置等操作。具体限流的逻辑直接写以<code>Java</code>带代码写在了项目业务中。</p>
<p>特别的，由于是通过<code>IP</code>来限流的，所以这里需要用大的几个处理<code>IP</code>地址的工具类就先贴出来。</p>
<blockquote>
<p>个人习惯，我贴代码会将所有<code>import</code>的包都一起贴进来，这样是方便后续回顾或者学习的时候处理一些包的问题，之前就遇到过很多类似的问题(可能对小白不太友好)，代码是有了，结果在导包的时候要么是对用到的哪些包不明所以，要么是同名的包过多，不知道怎么选择。</p>
</blockquote>
<h3 id="-2">3.1 IP工具类</h3>
<pre data-lang="java" style="background-color:#2b303b;color:#c0c5ce;" class="language-java "><code class="language-java" data-lang="java"><span style="color:#b48ead;">import </span><span>eu.bitwalker.useragentutils.</span><span style="color:#ebcb8b;">UserAgent</span><span>;
</span><span style="color:#b48ead;">import </span><span>lombok.extern.slf4j.</span><span style="color:#ebcb8b;">Slf4j</span><span>;
</span><span style="color:#b48ead;">import </span><span>org.apache.commons.lang3.</span><span style="color:#ebcb8b;">StringUtils</span><span>;
</span><span style="color:#b48ead;">import </span><span>org.lionsoul.ip2region.</span><span style="color:#ebcb8b;">DataBlock</span><span>;
</span><span style="color:#b48ead;">import </span><span>org.lionsoul.ip2region.</span><span style="color:#ebcb8b;">DbConfig</span><span>;
</span><span style="color:#b48ead;">import </span><span>org.lionsoul.ip2region.</span><span style="color:#ebcb8b;">DbSearcher</span><span>;
</span><span style="color:#b48ead;">import </span><span>org.lionsoul.ip2region.</span><span style="color:#ebcb8b;">Util</span><span>;
</span><span style="color:#b48ead;">import </span><span>org.springframework.core.io.</span><span style="color:#ebcb8b;">ClassPathResource</span><span>;
</span><span style="color:#b48ead;">import </span><span>org.springframework.stereotype.</span><span style="color:#ebcb8b;">Component</span><span>;
</span><span style="color:#b48ead;">import </span><span>org.springframework.util.</span><span style="color:#ebcb8b;">FileCopyUtils</span><span>;
</span><span style="color:#b48ead;">import </span><span>javax.annotation.</span><span style="color:#ebcb8b;">PostConstruct</span><span>;
</span><span style="color:#b48ead;">import </span><span>javax.servlet.http.</span><span style="color:#ebcb8b;">HttpServletRequest</span><span>;
</span><span style="color:#b48ead;">import </span><span>java.io.</span><span style="color:#ebcb8b;">InputStream</span><span>;
</span><span style="color:#b48ead;">import </span><span>java.lang.reflect.</span><span style="color:#ebcb8b;">Method</span><span>;
</span><span style="color:#b48ead;">import </span><span>java.net.</span><span style="color:#ebcb8b;">InetAddress</span><span>;
</span><span style="color:#b48ead;">import </span><span>java.net.</span><span style="color:#ebcb8b;">UnknownHostException</span><span>;
</span><span>
</span><span>
</span><span>@</span><span style="color:#bf616a;">Slf4j
</span><span>@</span><span style="color:#bf616a;">Component
</span><span style="color:#b48ead;">public class </span><span style="color:#ebcb8b;">IpUtils </span><span style="color:#eff1f5;">{
</span><span style="color:#eff1f5;">    
</span><span style="color:#eff1f5;">    
</span><span style="color:#eff1f5;">    </span><span style="color:#65737e;">/**
</span><span style="color:#65737e;">     * 获取ip地址
</span><span style="color:#65737e;">     */
</span><span style="color:#65737e;">    public static String getIpAddress(HttpServletRequest request) {
</span><span style="color:#65737e;">        String ipAddress = request.getHeader(&quot;X-Real-IP&quot;);
</span><span style="color:#65737e;">        if (ipAddress == null || ipAddress.length() == 0 || &quot;unknown&quot;.equalsIgnoreCase(ipAddress)) {
</span><span style="color:#65737e;">            ipAddress = request.getHeader(&quot;x-forwarded-for&quot;);
</span><span style="color:#65737e;">        }
</span><span style="color:#65737e;">        if (ipAddress == null || ipAddress.length() == 0 || &quot;unknown&quot;.equalsIgnoreCase(ipAddress)) {
</span><span style="color:#65737e;">            ipAddress = request.getHeader(&quot;Proxy-Client-IP&quot;);
</span><span style="color:#65737e;">        }
</span><span style="color:#65737e;">        if (ipAddress == null || ipAddress.length() == 0 || &quot;unknown&quot;.equalsIgnoreCase(ipAddress)) {
</span><span style="color:#65737e;">            ipAddress = request.getHeader(&quot;WL-Proxy-Client-IP&quot;);
</span><span style="color:#65737e;">        }
</span><span style="color:#65737e;">        if (ipAddress == null || ipAddress.length() == 0 || &quot;unknown&quot;.equalsIgnoreCase(ipAddress)) {
</span><span style="color:#65737e;">            ipAddress = request.getHeader(&quot;HTTP_CLIENT_IP&quot;);
</span><span style="color:#65737e;">        }
</span><span style="color:#65737e;">        if (ipAddress == null || ipAddress.length() == 0 || &quot;unknown&quot;.equalsIgnoreCase(ipAddress)) {
</span><span style="color:#65737e;">            ipAddress = request.getHeader(&quot;HTTP_X_FORWARDED_FOR&quot;);
</span><span style="color:#65737e;">        }
</span><span style="color:#65737e;">        if (ipAddress == null || ipAddress.length() == 0 || &quot;unknown&quot;.equalsIgnoreCase(ipAddress)) {
</span><span style="color:#65737e;">            ipAddress = request.getRemoteAddr();
</span><span style="color:#65737e;">            if (&quot;127.0.0.1&quot;.equals(ipAddress) || &quot;0:0:0:0:0:0:0:1&quot;.equals(ipAddress)) {
</span><span style="color:#65737e;">                //根据网卡取本机配置的IP
</span><span style="color:#65737e;">                InetAddress inet = null;
</span><span style="color:#65737e;">                try {
</span><span style="color:#65737e;">                    inet = InetAddress.getLocalHost();
</span><span style="color:#65737e;">                } catch (UnknownHostException e) {
</span><span style="color:#65737e;">                    log.error(&quot;getIpAddress exception:&quot;, e);
</span><span style="color:#65737e;">                }
</span><span style="color:#65737e;">                assert inet != null;
</span><span style="color:#65737e;">                ipAddress = inet.getHostAddress();
</span><span style="color:#65737e;">            }
</span><span style="color:#65737e;">        }
</span><span style="color:#65737e;">        return StringUtils.substringBefore(ipAddress, &quot;,&quot;);
</span><span style="color:#65737e;">    }
</span><span style="color:#65737e;">
</span><span style="color:#65737e;">    private static DbSearcher searcher;
</span><span style="color:#65737e;">    private static Method method;
</span><span style="color:#65737e;">
</span><span style="color:#65737e;">    /**
</span><span style="color:#65737e;">     * 在服务启动时加载 ip2region.db 到内存中
</span><span style="color:#65737e;">     */
</span><span style="color:#65737e;">    @PostConstruct
</span><span style="color:#65737e;">    private void initIp2regionResource() throws Exception {
</span><span style="color:#65737e;">        InputStream inputStream = new ClassPathResource(&quot;/ip/ip2region.db&quot;).getInputStream();
</span><span style="color:#65737e;">        //将 ip2region.db 转为 ByteArray
</span><span style="color:#65737e;">        byte[] dbBinStr = FileCopyUtils.copyToByteArray(inputStream);
</span><span style="color:#65737e;">        DbConfig dbConfig = new DbConfig();
</span><span style="color:#65737e;">        searcher = new DbSearcher(dbConfig, dbBinStr);
</span><span style="color:#65737e;">        //二进制方式初始化 DBSearcher，需要使用基于内存的查找算法 memorySearch
</span><span style="color:#65737e;">        method = searcher.getClass().getMethod(&quot;memorySearch&quot;, String.class);
</span><span style="color:#65737e;">    }
</span><span style="color:#65737e;">
</span><span style="color:#65737e;">    /**
</span><span style="color:#65737e;">     * 获取ip地址的归属地
</span><span style="color:#65737e;">     */
</span><span style="color:#eff1f5;">    </span><span style="color:#b48ead;">public static </span><span style="color:#ebcb8b;">String </span><span style="color:#8fa1b3;">getIpSource</span><span style="color:#eff1f5;">(</span><span style="color:#ebcb8b;">String </span><span style="color:#bf616a;">ipAddress</span><span style="color:#eff1f5;">) {
</span><span style="color:#eff1f5;">        </span><span style="color:#b48ead;">if </span><span style="color:#eff1f5;">(ipAddress </span><span>== </span><span style="color:#d08770;">null </span><span>|| !</span><span style="color:#ebcb8b;">Util</span><span style="color:#eff1f5;">.</span><span style="color:#bf616a;">isIpAddress</span><span style="color:#eff1f5;">(ipAddress)) {
</span><span style="color:#eff1f5;">            log.</span><span style="color:#bf616a;">error</span><span style="color:#eff1f5;">(</span><span>&quot;</span><span style="color:#a3be8c;">Error: Invalid ip address</span><span>&quot;</span><span style="color:#eff1f5;">);
</span><span style="color:#eff1f5;">            </span><span style="color:#b48ead;">return </span><span>&quot;&quot;</span><span style="color:#eff1f5;">;
</span><span style="color:#eff1f5;">        }
</span><span style="color:#eff1f5;">        </span><span style="color:#b48ead;">try </span><span style="color:#eff1f5;">{
</span><span style="color:#eff1f5;">            </span><span style="color:#ebcb8b;">DataBlock</span><span style="color:#eff1f5;"> dataBlock </span><span>= </span><span style="color:#eff1f5;">(</span><span style="color:#ebcb8b;">DataBlock</span><span style="color:#eff1f5;">) method.</span><span style="color:#bf616a;">invoke</span><span style="color:#eff1f5;">(searcher, ipAddress);
</span><span style="color:#eff1f5;">            </span><span style="color:#ebcb8b;">String</span><span style="color:#eff1f5;"> ipInfo </span><span>=</span><span style="color:#eff1f5;"> dataBlock.</span><span style="color:#bf616a;">getRegion</span><span style="color:#eff1f5;">();
</span><span style="color:#eff1f5;">            </span><span style="color:#b48ead;">if </span><span style="color:#eff1f5;">(</span><span>!</span><span style="color:#ebcb8b;">StringUtils</span><span style="color:#eff1f5;">.</span><span style="color:#bf616a;">isEmpty</span><span style="color:#eff1f5;">(ipInfo)) {
</span><span style="color:#eff1f5;">                ipInfo </span><span>=</span><span style="color:#eff1f5;"> ipInfo.</span><span style="color:#bf616a;">replace</span><span style="color:#eff1f5;">(</span><span>&quot;</span><span style="color:#a3be8c;">|0</span><span>&quot;</span><span style="color:#eff1f5;">, </span><span>&quot;&quot;</span><span style="color:#eff1f5;">);
</span><span style="color:#eff1f5;">                ipInfo </span><span>=</span><span style="color:#eff1f5;"> ipInfo.</span><span style="color:#bf616a;">replace</span><span style="color:#eff1f5;">(</span><span>&quot;</span><span style="color:#a3be8c;">0|</span><span>&quot;</span><span style="color:#eff1f5;">, </span><span>&quot;&quot;</span><span style="color:#eff1f5;">);
</span><span style="color:#eff1f5;">                </span><span style="color:#b48ead;">return</span><span style="color:#eff1f5;"> ipInfo;
</span><span style="color:#eff1f5;">            }
</span><span style="color:#eff1f5;">        } </span><span style="color:#b48ead;">catch </span><span style="color:#eff1f5;">(</span><span style="color:#ebcb8b;">Exception </span><span style="color:#bf616a;">e</span><span style="color:#eff1f5;">) {
</span><span style="color:#eff1f5;">            log.</span><span style="color:#bf616a;">error</span><span style="color:#eff1f5;">(</span><span>&quot;</span><span style="color:#a3be8c;">getCityInfo exception:</span><span>&quot;</span><span style="color:#eff1f5;">, e);
</span><span style="color:#eff1f5;">        }
</span><span style="color:#eff1f5;">        </span><span style="color:#b48ead;">return </span><span>&quot;&quot;</span><span style="color:#eff1f5;">;
</span><span style="color:#eff1f5;">    }
</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">    </span><span style="color:#b48ead;">public static </span><span style="color:#ebcb8b;">String </span><span style="color:#8fa1b3;">getIpProvince</span><span style="color:#eff1f5;">(</span><span style="color:#ebcb8b;">String </span><span style="color:#bf616a;">ipSource</span><span style="color:#eff1f5;">) {
</span><span style="color:#eff1f5;">        </span><span style="color:#ebcb8b;">String</span><span style="color:#b48ead;">[]</span><span style="color:#eff1f5;"> strings </span><span>=</span><span style="color:#eff1f5;"> ipSource.</span><span style="color:#bf616a;">split</span><span style="color:#eff1f5;">(</span><span>&quot;</span><span style="color:#96b5b4;">\\</span><span style="color:#a3be8c;">|</span><span>&quot;</span><span style="color:#eff1f5;">);
</span><span style="color:#eff1f5;">        </span><span style="color:#b48ead;">if </span><span style="color:#eff1f5;">(strings[</span><span style="color:#d08770;">1</span><span style="color:#eff1f5;">].</span><span style="color:#bf616a;">endsWith</span><span style="color:#eff1f5;">(</span><span>&quot;</span><span style="color:#a3be8c;">省</span><span>&quot;</span><span style="color:#eff1f5;">)) {
</span><span style="color:#eff1f5;">            </span><span style="color:#b48ead;">return </span><span style="color:#ebcb8b;">StringUtils</span><span style="color:#eff1f5;">.</span><span style="color:#bf616a;">substringBefore</span><span style="color:#eff1f5;">(strings[</span><span style="color:#d08770;">1</span><span style="color:#eff1f5;">], </span><span>&quot;</span><span style="color:#a3be8c;">省</span><span>&quot;</span><span style="color:#eff1f5;">);
</span><span style="color:#eff1f5;">        }
</span><span style="color:#eff1f5;">        </span><span style="color:#b48ead;">return</span><span style="color:#eff1f5;"> strings[</span><span style="color:#d08770;">1</span><span style="color:#eff1f5;">];
</span><span style="color:#eff1f5;">    }
</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">    </span><span style="color:#65737e;">/**
</span><span style="color:#65737e;">     * 获取访问设备
</span><span style="color:#65737e;">     */
</span><span style="color:#65737e;">    public static UserAgent getUserAgent(HttpServletRequest request) {
</span><span style="color:#65737e;">        return UserAgent.parseUserAgentString(request.getHeader(&quot;User-Agent&quot;));
</span><span style="color:#65737e;">    }
</span><span style="color:#65737e;">}
</span></code></pre>
<hr />
<h3 id="-3">3.2 定义限流注解</h3>
<p>为了使用方便，我这里选择了注解的方式，这样在使用的时候只需要在需要进行限流的请求<code>Controller</code>上添加一个注解即可。就像这样:</p>
<p><img src="https://images.waer.ltd/img/image-20221229211158557.png" alt="image-20221229211158557" loading="lazy" decoding="async" /></p>
<blockquote>
<p>自定义的限流注解其实很简单，主要包含限流的Key，限流周期以及请求计数器。当然，这些数据都是完全可以自定义的，并没有什么约定俗成，具体工具自己的业务需要决定就好。</p>
</blockquote>
<pre data-lang="java" style="background-color:#2b303b;color:#c0c5ce;" class="language-java "><code class="language-java" data-lang="java"><span style="color:#b48ead;">import </span><span>java.lang.annotation.*;
</span><span style="color:#65737e;">/**
</span><span style="color:#65737e;"> * </span><span style="color:#b48ead;">@author</span><span style="color:#65737e;">: 八尺妖剑
</span><span style="color:#65737e;"> * @date: 2022/10/19 12:34
</span><span style="color:#65737e;"> * @email: ilikexff@gmail.com
</span><span style="color:#65737e;"> * @blog: https://www.waer.ltd
</span><span style="color:#65737e;"> * @Description: 自定义注解:接口限流
</span><span style="color:#65737e;"> */
</span><span>@</span><span style="color:#bf616a;">Documented
</span><span>@</span><span style="color:#bf616a;">Retention</span><span>(</span><span style="color:#ebcb8b;">RetentionPolicy</span><span>.</span><span style="color:#d08770;">RUNTIME</span><span>)
</span><span>@</span><span style="color:#bf616a;">Target</span><span>(</span><span style="color:#ebcb8b;">ElementType</span><span>.</span><span style="color:#d08770;">METHOD</span><span>)
</span><span style="color:#b48ead;">public @interface </span><span style="color:#ebcb8b;">RateLimit </span><span style="color:#eff1f5;">{
</span><span style="color:#eff1f5;">    </span><span style="color:#65737e;">/**
</span><span style="color:#65737e;">     * 限流的key
</span><span style="color:#65737e;">     */
</span><span style="color:#65737e;">    String key() default &quot;limit&quot;;
</span><span style="color:#65737e;">
</span><span style="color:#65737e;">    /**
</span><span style="color:#65737e;">     * 周期：单位秒
</span><span style="color:#65737e;">     * </span><span style="color:#b48ead;">@return
</span><span style="color:#65737e;">     */
</span><span style="color:#65737e;">    int cycles() default 5;
</span><span style="color:#65737e;">
</span><span style="color:#65737e;">    /**
</span><span style="color:#65737e;">     * 请求次数
</span><span style="color:#65737e;">     * </span><span style="color:#b48ead;">@return
</span><span style="color:#65737e;">     */
</span><span style="color:#65737e;">    int count() default 1;
</span><span style="color:#65737e;">}
</span></code></pre>
<hr />
<h3 id="-4">3.3 自定义拦截器</h3>
<blockquote>
<p>这里使用到了拦截器，主要作用就是拦截处理所有的请求进行拦截，主要用到的<code>preHandle</code>方法。所有的限流逻辑都在这里实现。所以这部分挺重要的。</p>
</blockquote>
<pre data-lang="java" style="background-color:#2b303b;color:#c0c5ce;" class="language-java "><code class="language-java" data-lang="java"><span style="color:#65737e;">/**
</span><span style="color:#65737e;"> * </span><span style="color:#b48ead;">@author</span><span style="color:#65737e;">: 八尺妖剑
</span><span style="color:#65737e;"> * @date: 2022/10/19 12:38
</span><span style="color:#65737e;"> * @email: ilikexff@gmail.com
</span><span style="color:#65737e;"> * @blog: https://www.waer.ltd
</span><span style="color:#65737e;"> * @Description: 拦截器:处理接口限流
</span><span style="color:#65737e;"> */
</span><span>@</span><span style="color:#bf616a;">Component
</span><span style="color:#b48ead;">public class </span><span style="color:#ebcb8b;">RateLimitInterceptor </span><span style="color:#b48ead;">implements </span><span style="color:#a3be8c;">HandlerInterceptor </span><span style="color:#eff1f5;">{
</span><span style="color:#eff1f5;">    @</span><span style="color:#bf616a;">Resource
</span><span style="color:#eff1f5;">    </span><span style="color:#b48ead;">private </span><span style="color:#ebcb8b;">RedisTemplate</span><span style="color:#eff1f5;">&lt;</span><span style="color:#ebcb8b;">String</span><span style="color:#eff1f5;">,</span><span style="color:#ebcb8b;">Integer</span><span style="color:#eff1f5;">&gt; redisTemplate;
</span><span style="color:#eff1f5;">    @</span><span style="color:#bf616a;">Autowired
</span><span style="color:#eff1f5;">    </span><span style="color:#b48ead;">private </span><span style="color:#ebcb8b;">EmailUtils </span><span style="color:#eff1f5;">emailUtils;
</span><span style="color:#eff1f5;">    @</span><span style="color:#bf616a;">Override
</span><span style="color:#eff1f5;">    </span><span style="color:#b48ead;">public boolean </span><span style="color:#8fa1b3;">preHandle</span><span style="color:#eff1f5;">(</span><span style="color:#ebcb8b;">HttpServletRequest </span><span style="color:#bf616a;">request</span><span style="color:#eff1f5;">, </span><span style="color:#ebcb8b;">HttpServletResponse </span><span style="color:#bf616a;">response</span><span style="color:#eff1f5;">, </span><span style="color:#ebcb8b;">Object </span><span style="color:#bf616a;">handler</span><span style="color:#eff1f5;">) </span><span style="color:#b48ead;">throws </span><span style="color:#ebcb8b;">Exception </span><span style="color:#eff1f5;">{
</span><span style="color:#eff1f5;">        </span><span style="color:#65737e;">// 如果请求的是方法，则需要做校验
</span><span style="color:#eff1f5;">        </span><span style="color:#b48ead;">if </span><span style="color:#eff1f5;">(handler </span><span>instanceof </span><span style="color:#ebcb8b;">HandlerMethod</span><span style="color:#eff1f5;">) {
</span><span style="color:#eff1f5;">            </span><span style="color:#ebcb8b;">HandlerMethod</span><span style="color:#eff1f5;"> handlerMethod </span><span>= </span><span style="color:#eff1f5;">(</span><span style="color:#ebcb8b;">HandlerMethod</span><span style="color:#eff1f5;">) handler;
</span><span style="color:#eff1f5;">            </span><span style="color:#65737e;">// 获取目标方法上是否有指定注解
</span><span style="color:#eff1f5;">            </span><span style="color:#ebcb8b;">RateLimit</span><span style="color:#eff1f5;"> rateLimit </span><span>=</span><span style="color:#eff1f5;"> handlerMethod.</span><span style="color:#bf616a;">getMethodAnnotation</span><span style="color:#eff1f5;">(</span><span style="color:#ebcb8b;">RateLimit</span><span style="color:#eff1f5;">.</span><span style="color:#bf616a;">class</span><span style="color:#eff1f5;">);
</span><span style="color:#eff1f5;">            </span><span style="color:#b48ead;">if </span><span style="color:#eff1f5;">(rateLimit </span><span>== </span><span style="color:#d08770;">null</span><span style="color:#eff1f5;">) {
</span><span style="color:#eff1f5;">                </span><span style="color:#65737e;">//说明目标方法上没有 RateLimit 注解
</span><span style="color:#eff1f5;">                </span><span style="color:#b48ead;">return </span><span style="color:#d08770;">true</span><span style="color:#eff1f5;">;
</span><span style="color:#eff1f5;">            }
</span><span style="color:#eff1f5;">            </span><span style="color:#65737e;">// 说明目标方法上有 RateLimit 注解，所以需要校验这个请求是不是在刷接口
</span><span style="color:#eff1f5;">            </span><span style="color:#65737e;">// 获取请求IP地址
</span><span style="color:#eff1f5;">            </span><span style="color:#ebcb8b;">String</span><span style="color:#eff1f5;"> ip </span><span>= </span><span style="color:#ebcb8b;">IpUtils</span><span style="color:#eff1f5;">.</span><span style="color:#bf616a;">getIpAddress</span><span style="color:#eff1f5;">(request);
</span><span style="color:#eff1f5;">            </span><span style="color:#65737e;">// 请求url路径
</span><span style="color:#eff1f5;">            </span><span style="color:#ebcb8b;">String</span><span style="color:#eff1f5;"> uri </span><span>=</span><span style="color:#eff1f5;"> request.</span><span style="color:#bf616a;">getRequestURI</span><span style="color:#eff1f5;">();
</span><span style="color:#eff1f5;">            </span><span style="color:#65737e;">//存到redis中的key
</span><span style="color:#eff1f5;">            </span><span style="color:#ebcb8b;">String</span><span style="color:#eff1f5;"> key </span><span>= &quot;</span><span style="color:#a3be8c;">RateLimit:</span><span>&quot; +</span><span style="color:#eff1f5;"> ip </span><span>+ &quot;</span><span style="color:#a3be8c;">:</span><span>&quot; +</span><span style="color:#eff1f5;"> uri;
</span><span style="color:#eff1f5;">            </span><span style="color:#65737e;">// 缓存中存在key，在限定访问周期内已经调用过当前接口
</span><span style="color:#eff1f5;">            </span><span style="color:#b48ead;">if </span><span style="color:#eff1f5;">(redisTemplate.</span><span style="color:#bf616a;">hasKey</span><span style="color:#eff1f5;">(key)) {
</span><span style="color:#eff1f5;">                </span><span style="color:#65737e;">// 访问次数自增1
</span><span style="color:#eff1f5;">                redisTemplate.</span><span style="color:#bf616a;">opsForValue</span><span style="color:#eff1f5;">().</span><span style="color:#bf616a;">increment</span><span style="color:#eff1f5;">(key, </span><span style="color:#d08770;">1</span><span style="color:#eff1f5;">);
</span><span style="color:#eff1f5;">                </span><span style="color:#ebcb8b;">Integer</span><span style="color:#eff1f5;"> count </span><span>=</span><span style="color:#eff1f5;"> redisTemplate.</span><span style="color:#bf616a;">opsForValue</span><span style="color:#eff1f5;">().</span><span style="color:#bf616a;">get</span><span style="color:#eff1f5;">(key);
</span><span style="color:#eff1f5;">                </span><span style="color:#65737e;">// 超出访问次数限制
</span><span style="color:#eff1f5;">                </span><span style="color:#b48ead;">if </span><span style="color:#eff1f5;">(count </span><span>&gt;</span><span style="color:#eff1f5;"> rateLimit.</span><span style="color:#bf616a;">count</span><span style="color:#eff1f5;">()) {
</span><span style="color:#eff1f5;">                    </span><span style="color:#ebcb8b;">String</span><span style="color:#eff1f5;"> from </span><span>= </span><span style="color:#ebcb8b;">IpUtils</span><span style="color:#eff1f5;">.</span><span style="color:#bf616a;">getIpSource</span><span style="color:#eff1f5;">(ip);
</span><span style="color:#eff1f5;">                    </span><span style="color:#ebcb8b;">EmailDTO</span><span style="color:#eff1f5;"> emailDTO </span><span>= </span><span style="color:#bf616a;">SendEmailForRateLimit</span><span style="color:#eff1f5;">(ip,uri,from);
</span><span style="color:#eff1f5;">                    </span><span style="color:#ebcb8b;">CompletableFuture</span><span style="color:#eff1f5;">.</span><span style="color:#bf616a;">supplyAsync</span><span style="color:#eff1f5;">(()</span><span style="color:#b48ead;">-&gt;</span><span style="color:#eff1f5;">{
</span><span style="color:#eff1f5;">                        </span><span style="color:#b48ead;">return</span><span style="color:#eff1f5;"> count</span><span>==</span><span style="color:#d08770;">50 </span><span>? </span><span style="color:#d08770;">true </span><span>: </span><span style="color:#d08770;">false</span><span style="color:#eff1f5;">;
</span><span style="color:#eff1f5;">                    }).</span><span style="color:#bf616a;">thenApplyAsync</span><span style="color:#eff1f5;">(</span><span style="color:#bf616a;">num</span><span style="color:#b48ead;">-&gt;</span><span style="color:#ebcb8b;">CompletableFuture</span><span style="color:#eff1f5;">.</span><span style="color:#bf616a;">supplyAsync</span><span style="color:#eff1f5;">(() </span><span style="color:#b48ead;">-&gt; </span><span style="color:#eff1f5;">{
</span><span style="color:#eff1f5;">                        </span><span style="color:#65737e;">//System.out.println(&quot;num:&quot; + num);
</span><span style="color:#eff1f5;">                        </span><span style="color:#b48ead;">if</span><span style="color:#eff1f5;">(num) {
</span><span style="color:#eff1f5;">                            emailUtils.</span><span style="color:#bf616a;">sendHtmlMail</span><span style="color:#eff1f5;">(emailDTO);
</span><span style="color:#eff1f5;">                        }
</span><span style="color:#eff1f5;">                        </span><span style="color:#b48ead;">return </span><span>&quot;</span><span style="color:#a3be8c;">邮件发送完成</span><span>&quot;</span><span style="color:#eff1f5;">;
</span><span style="color:#eff1f5;">                    }));
</span><span style="color:#eff1f5;">                    </span><span style="color:#b48ead;">throw  new </span><span style="color:#ebcb8b;">BizException</span><span style="color:#eff1f5;">(</span><span style="color:#ebcb8b;">StatusCodeEnum</span><span style="color:#eff1f5;">.</span><span style="color:#d08770;">RATE_LIMIT_REQUEST</span><span style="color:#eff1f5;">);
</span><span style="color:#eff1f5;">                }
</span><span style="color:#eff1f5;">                </span><span style="color:#65737e;">// 未超出访问次数限制，不进行任何操作，返回true
</span><span style="color:#eff1f5;">            } </span><span style="color:#b48ead;">else </span><span style="color:#eff1f5;">{
</span><span style="color:#eff1f5;">                </span><span style="color:#65737e;">// 第一次设置数据,过期时间为注解确定的访问周期
</span><span style="color:#eff1f5;">                redisTemplate.</span><span style="color:#bf616a;">opsForValue</span><span style="color:#eff1f5;">().</span><span style="color:#bf616a;">set</span><span style="color:#eff1f5;">(key, </span><span style="color:#d08770;">1</span><span style="color:#eff1f5;">, rateLimit.</span><span style="color:#bf616a;">cycles</span><span style="color:#eff1f5;">(), </span><span style="color:#ebcb8b;">TimeUnit</span><span style="color:#eff1f5;">.</span><span style="color:#d08770;">SECONDS</span><span style="color:#eff1f5;">);
</span><span style="color:#eff1f5;">            }
</span><span style="color:#eff1f5;">            </span><span style="color:#b48ead;">return </span><span style="color:#d08770;">true</span><span style="color:#eff1f5;">;
</span><span style="color:#eff1f5;">        }
</span><span style="color:#eff1f5;">        </span><span style="color:#65737e;">//如果请求的不是方法，直接放行
</span><span style="color:#eff1f5;">        </span><span style="color:#b48ead;">return </span><span style="color:#d08770;">true</span><span style="color:#eff1f5;">;
</span><span style="color:#eff1f5;">    }
</span></code></pre>
<blockquote>
<p>代码中已经写了详细的注释，所以就不再具体展开，需要注意的是，其中涉及到邮件发送的部分是我自己增加的一个安全提醒的部分逻辑，所以这部分可以忽略掉，不算在限流逻辑中也是没有任何毛病的。</p>
</blockquote>
<hr />
<h2 id="-5">4.实际使用之后的效果</h2>
<p>到这一步，所有的工作都完成了，前面也提到过使用是非常简单的，我们只需要在要进行限流的请求方法上加上注解<code>@RateLimit(cycles = 125,count = 3)</code>即可，至于括号内的限流参数，那就根据自己的需求设置了，比如我这里写的就是125秒内同一个IP只能进行3次请求，否则就会触发限流，请求拒绝。</p>
<p><strong>正常请求</strong></p>
<p><img src="https://images.waer.ltd/img/image-20221229214108308.png" alt="image-20221229214108308" loading="lazy" decoding="async" /></p>
<p><strong>请求限流</strong></p>
<p><img src="https://images.waer.ltd/img/image-20221229214200435.png" alt="image-20221229214200435" loading="lazy" decoding="async" /></p>
<p><strong>Redis中记录的数据</strong></p>
<p><img src="https://images.waer.ltd/img/image-20221229214335152.png" alt="image-20221229214335152" loading="lazy" decoding="async" /></p>
<blockquote>
<p>注意，限流触发的提示信息建议自己写一个，我承认，我自己这个提示确实不太友好，这主要是当时被对面搞那么一出，就很气人，所以在语言提示上就有些不够友好，如果需要自定义，只需要修改下面的常量数据就可。</p>
</blockquote>
<p><img src="https://images.waer.ltd/img/image-20221229212951790.png" alt="image-20221229212951790" loading="lazy" decoding="async" /></p>
<hr />
<h2 id="-6">5.关于计数器限流方案的一些总结</h2>
<p>通过上面一波湿滑操作，我们已经以通过计数器这种方式具体应用到了实际的项目中，但这并不是故事的结束，每一种方法都有它独到的优势，自然也会有自己的不足，对于计数器实现的限流方案，其实还是有不少问题的。</p>
<p>考虑下面这种情况:</p>
<blockquote>
<p>​	假设对于某一些接口的需求是每分钟允许的请求上限是100次，如果某用户在最后那第59秒最后几毫秒瞬间直接给你来100个请求，当这一秒结束之后，计数器完成清零工作，此时该用户在下一秒的时候又给你整100个请求过来，啪一下就过来了，很快啊，那么1秒内这个很皮的用户就发送了2倍的请求，显然在这个情况下，一切也都是符合计数器限流原理的。</p>
<p>​	这就是该方法的缺陷(<strong>不能很好的处理时间单位的边界</strong>)，这种情况的存在，可能会导致系统一不小心就承受了太多，甚至击穿系统，所以这也是为什么还有其他几种方案的原因之一。</p>
</blockquote>
<p>至此就完成了一次接口限流的操作实践。最后，<strong>纸上得来终觉浅啊哥</strong>！</p>

        </div>
      </div>
      <div class="prompt" id="terminal"><input
    type="text"
    id="setter"
    onkeydown="writeit(this, event);moveIt(this.value.length, event)"
    onchange="writeit(this, event)"
    onkeyup="writeit(this, event)"
    onkeypress="writeit(this, event);"
    >
<label for="setter" id="writer"> </label><b class="cursor" id="cursor"></b></div>
      <footer class="footer">
        <div class="footer-content">
          <p class="icp-info">
            <a href="https://beian.miit.gov.cn/" target="_blank" rel="noopener noreferrer">黔ICP备2021010295号</a>
          </p>
        </div>
      </footer>
    </main>
  </body>

</html>
